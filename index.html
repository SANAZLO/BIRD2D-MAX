<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eagle Journey: Smooth 2D</title>
    <style>
        body { margin: 0; overflow: hidden; background: #0b1522; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        canvas { display: block; }
        
        #ui { position: fixed; top: 20px; width: 100%; text-align: center; color: white; pointer-events: none; z-index: 10; }
        .score { font-size: 50px; font-weight: bold; text-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #timer { font-size: 80px; color: #f1c40f; position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); text-shadow: 0 0 20px rgba(0,0,0,0.5); z-index: 50; }

        #game-over {
            position: fixed; inset: 0; background: rgba(0,5,15,0.95);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; color: white; backdrop-filter: blur(10px);
        }
        .leaderboard { background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; margin: 20px 0; border: 1px solid #333; min-width: 280px; }
        .lb-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .btn { padding: 18px 60px; background: #c0392b; border: none; color: white; font-size: 20px; font-weight: bold; cursor: pointer; border-radius: 5px; transition: 0.3s; }
        .btn:hover { background: #e74c3c; transform: scale(1.05); }
    </style>
</head>
<body>

    <div id="ui">
        <div class="score" id="score">0</div>
        <div id="best-ui" style="opacity: 0.6; letter-spacing: 2px;">РЕКОРД: 0</div>
    </div>

    <div id="timer"></div>

    <div id="game-over">
        <h1 style="font-size: 40px; letter-spacing: 5px; margin-bottom: 0;">СТОЛКНОВЕНИЕ</h1>
        <div class="leaderboard">
            <h3 style="margin-top: 0; color: #f1c40f;">ТОП ПОЛЕТОВ:</h3>
            <div id="lb-list"></div>
        </div>
        <button class="btn" onclick="reset()">ЛЕТЕТЬ СНОВА</button>
    </div>

    <canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const timerEl = document.getElementById('timer');
const overScreen = document.getElementById('game-over');

let w, h, bird, pipes, clouds, score, isOver, frame, gameStarted;

// Глобальные настройки для ПЛАВНОСТИ
const GRAVITY = 0.18; 
const FLAP_STRENGTH = -5.2; 
const PIPE_SPEED = 3.0; 

function init() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
    score = 0;
    isOver = false;
    frame = 0;
    gameStarted = false;
    pipes = [];
    clouds = [];

    bird = {
        x: w * 0.25,
        y: h / 2,
        v: 0,
        radius: 20,
        angle: 0,
        wing: 0,
        targetAngle: 0
    };

    for(let i=0; i<5; i++) clouds.push({x: Math.random()*w, y: Math.random()*h*0.5, s: 0.2 + Math.random()});

    updateLeaderboardUI();
    countdown();
}

function countdown() {
    let count = 3;
    timerEl.innerText = "ПРИГОТОВИТЬСЯ...";
    let t = setInterval(() => {
        count--;
        if(count <= 0) {
            clearInterval(t);
            timerEl.innerText = "";
            gameStarted = true;
        } else {
            timerEl.innerText = count;
        }
    }, 1000);
}

function drawBird() {
    ctx.save();
    ctx.translate(bird.x, bird.y);
    bird.targetAngle = Math.min(Math.PI/4, Math.max(-Math.PI/4, bird.v * 0.08));
    bird.angle += (bird.targetAngle - bird.angle) * 0.1; 
    ctx.rotate(bird.angle);
    
    // Крылья
    ctx.fillStyle = '#4e342e';
    let s = Math.sin(bird.wing) * 22;
    ctx.beginPath();
    ctx.moveTo(-15, 0); ctx.quadraticCurveTo(0, -s - 25, 15, 0); ctx.fill();

    // Тело
    ctx.fillStyle = '#3e2723';
    ctx.beginPath(); ctx.ellipse(0, 0, 26, 11, 0, 0, Math.PI*2); ctx.fill();
    
    // Белая голова
    ctx.fillStyle = '#fff';
    ctx.beginPath(); ctx.arc(18, -4, 10, 0, Math.PI*2); ctx.fill();

    // Клюв
    ctx.fillStyle = '#fbc02d';
    ctx.beginPath(); ctx.moveTo(24, -4); ctx.lineTo(36, -1); ctx.lineTo(24, 2); ctx.fill();

    ctx.restore();
}

function drawWorld() {
    let sky = ctx.createLinearGradient(0, 0, 0, h);
    sky.addColorStop(0, '#1565c0'); sky.addColorStop(1, '#64b5f6');
    ctx.fillStyle = sky; ctx.fillRect(0, 0, w, h);

    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    clouds.forEach(c => {
        c.x -= PIPE_SPEED * 0.3 * c.s;
        if(c.x < -100) c.x = w + 100;
        ctx.beginPath(); ctx.arc(c.x, c.y, 30*c.s, 0, Math.PI*2); ctx.fill();
    });

    pipes.forEach(p => {
        let g = ctx.createLinearGradient(p.x, 0, p.x + p.w, 0);
        g.addColorStop(0, p.type === 'top' ? '#455a64' : '#2e7d32');
        g.addColorStop(1, '#000');
        ctx.fillStyle = g;
        
        if(p.type === 'top') {
            ctx.fillRect(p.x, 0, p.w, p.h);
        } else {
            ctx.fillRect(p.x, h - p.h, p.w, p.h);
            ctx.fillStyle = '#1b5e20';
            for(let i=0; i<3; i++) {
                ctx.beginPath();
                ctx.moveTo(p.x + i*30, h-p.h); ctx.lineTo(p.x+15+i*30, h-p.h-30); ctx.lineTo(p.x+30+i*30, h-p.h); ctx.fill();
            }
        }
    });
}

function update() {
    if(!gameStarted || isOver) {
        bird.y += Math.sin(frame*0.05) * 0.5; 
        frame++; return;
    }

    bird.v += GRAVITY;
    bird.y += bird.v;
    bird.wing += 0.15;

    if(frame % 140 === 0) {
        let gap = 280; 
        let topH = 100 + Math.random() * (h - gap - 200);
        pipes.push({x: w, w: 90, h: topH, type: 'top', passed: false});
        pipes.push({x: w, w: 90, h: h - topH - gap, type: 'bot'});
    }

    pipes.forEach((p, i) => {
        p.x -= PIPE_SPEED;
        if(bird.x + 15 > p.x && bird.x - 15 < p.x + p.w) {
            if(p.type === 'top' && bird.y - 10 < p.h) die();
            if(p.type === 'bot' && bird.y + 10 > h - p.h) die();
        }
        if(!p.passed && p.type === 'top' && p.x < bird.x) {
            score++; p.passed = true;
            document.getElementById('score').innerText = score;
        }
        if(p.x < -100) pipes.splice(i, 1);
    });

    if(bird.y > h || bird.y < 0) die();
    frame++;
}

function die() {
    isOver = true;
    let hist = JSON.parse(localStorage.getItem('bird_scores_max') || "[]");
    hist.push(score); hist.sort((a,b)=>b-a);
    localStorage.setItem('bird_scores_max', JSON.stringify(hist.slice(0,5)));
    updateLeaderboardUI();
    overScreen.style.display = 'flex';
}

function updateLeaderboardUI() {
    let hist = JSON.parse(localStorage.getItem('bird_scores_max') || "[]");
    document.getElementById('lb-list').innerHTML = hist.map((s,i) => `
        <div class="lb-item"><span>#${i+1} результат</span> <b>${s} очков</b></div>
    `).join('');
    document.getElementById('best-ui').innerText = "РЕКОРД: " + (hist[0] || 0);
}

function reset() { overScreen.style.display = 'none'; init(); }
function flap() { if(gameStarted && !isOver) bird.v = FLAP_STRENGTH; }

window.onkeydown = (e) => { if(e.code === 'Space') flap(); };
canvas.ontouchstart = (e) => { flap(); e.preventDefault(); };

function loop() {
    ctx.clearRect(0,0,w,h);
    drawWorld();
    drawBird();
    update();
    requestAnimationFrame(loop);
}

init();
loop();
window.onresize = () => { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; };
</script>
</body>
</html>
